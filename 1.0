<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG ë—ëª© í‚¤ìš°ê¸° (Raft RPG)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.module.js"
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap');

        body { margin: 0; overflow: hidden; touch-action: none; user-select: none; font-family: 'Noto Sans KR', sans-serif; background: #000; }
        
        /* UI Base */
        .pixel-font { font-family: 'Black Han Sans', sans-serif; }
        .text-shadow { text-shadow: 2px 2px 0 #000; }
        
        /* Joystick */
        #joystick-zone {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 140px; height: 140px;
            background: rgba(255, 255, 255, 0.05); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex; justify-content: center; align-items: center; pointer-events: auto; z-index: 50;
            backdrop-filter: blur(2px);
        }
        #joystick-knob {
            width: 60px; height: 60px; background: rgba(255, 255, 255, 0.9); border-radius: 50%;
            position: absolute; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            background: radial-gradient(circle at 30% 30%, #fff, #ccc);
        }

        /* Action Buttons - High Z-Index to prevent being blocked */
        #build-menu-btn { 
            position: absolute; bottom: 50px; right: 30px; 
            width: 70px; height: 70px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white; border-radius: 16px; 
            font-weight: bold; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.4); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.1s; cursor: pointer; pointer-events: auto; z-index: 60;
            font-size: 12px;
        }
        #build-menu-btn:active { transform: scale(0.95); }

        #cheat-menu-btn {
            position: absolute; bottom: 130px; right: 30px;
            width: 50px; height: 50px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white; border-radius: 50%;
            font-weight: bold; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            display: flex; justify-content: center; align-items: center; font-size: 24px;
            cursor: pointer; pointer-events: auto; z-index: 60;
        }
        #cheat-menu-btn:active { transform: scale(0.9); }

        /* Top Panel Container */
        #top-panel {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px;
            display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: none; z-index: 60; box-sizing: border-box;
        }

        /* Left Info Column */
        #left-col { display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }

        /* Level Badge */
        #level-container { display: flex; align-items: center; gap: 10px; cursor: pointer; pointer-events: auto; }
        #level-badge {
            width: 50px; height: 50px; background: linear-gradient(135deg, #fbbf24, #d97706);
            border-radius: 50%; border: 3px solid #fff;
            display: flex; justify-content: center; align-items: center;
            font-weight: 900; font-size: 24px; color: white; text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #xp-bar-container {
            flex: 1; height: 20px; background: #333; width: 120px; border-radius: 10px; 
            overflow: hidden; border: 2px solid #555; position: relative; margin-left: -10px; padding-left: 15px; z-index: -1;
        }
        #xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #34d399, #10b981); transition: width 0.5s; }
        #xp-text { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 10px; line-height: 18px; color: white; font-weight: bold; }

        /* Safe Resource Warehouse */
        #warehouse-panel {
            background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 12px; border: 1px solid #666;
            display: flex; flex-direction: column; gap: 4px; backdrop-filter: blur(4px); min-width: 100px; pointer-events: auto;
        }
        .wh-header { font-size: 11px; color: #9ca3af; border-bottom: 1px solid #555; margin-bottom: 2px; }
        .wh-item { color: white; font-size: 13px; font-weight: bold; display: flex; justify-content: space-between; }

        /* Equipment Panel */
        #equip-panel {
            position: absolute; top: 50%; left: 15px; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 10px; pointer-events: none; z-index: 50;
        }
        .equip-badge {
            background: rgba(0,0,0,0.8); border-radius: 50px; padding: 6px 14px 6px 6px;
            display: flex; align-items: center; gap: 8px; border: 2px solid #444;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .equip-icon { 
            width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 18px; background: #333; border: 2px solid #fff;
        }
        .equip-info { display: flex; flex-direction: column; }
        .equip-label { font-size: 10px; color: #aaa; line-height: 1; }
        .equip-val { font-size: 16px; font-weight: bold; color: white; line-height: 1; }

        /* Backpack */
        #backpack-panel {
            pointer-events: auto; 
            background: rgba(0,0,0,0.7); border: 2px solid #fbbf24; border-radius: 12px;
            padding: 10px; min-width: 140px; display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .bp-header { font-size: 12px; color: #fbbf24; font-weight: bold; border-bottom: 1px solid #555; padding-bottom: 4px; display: flex; justify-content: space-between; }
        #backpack-slots { display: flex; gap: 2px; flex-wrap: wrap; justify-content: flex-end; }
        .backpack-slot { width: 28px; height: 28px; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 16px; border: 1px solid #444; }

        /* Stats Panel */
        #stats-panel {
            position: absolute; bottom: 30px; left: 20px;
            display: flex; flex-direction: column; gap: 4px; pointer-events: none; z-index: 50;
        }
        .stat-bar-box { width: 120px; height: 14px; background: rgba(0,0,0,0.6); border-radius: 7px; overflow: hidden; border: 1px solid #555; position: relative; }
        .stat-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp-fill { background: linear-gradient(90deg, #f87171, #ef4444); }
        .oxy-fill { background: linear-gradient(90deg, #60a5fa, #3b82f6); }
        .stat-icon { position: absolute; left: 4px; top: 0; font-size: 10px; line-height: 14px; color: white; text-shadow: 1px 1px 0 #000; font-weight: bold; z-index: 2; }

        /* Overlay Labels */
        #ui-layer { pointer-events: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 10; }
        .req-label {
            position: absolute; transform: translate(-50%, -100%);
            background: rgba(0,0,0,0.7); color: #ef4444; padding: 4px 8px; border-radius: 6px;
            font-size: 11px; font-weight: bold; border: 1px solid #ef4444; white-space: nowrap;
        }
        .zone-label {
            position: absolute; transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.8); font-size: 14px; font-weight: bold;
            text-shadow: 0 0 4px #000; pointer-events: none; text-align: center;
        }
        .gauge-container { position: absolute; width: 40px; height: 40px; transform: translate(-50%, -50%); }

        /* Notifications */
        #notification-area {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 5px; align-items: center; pointer-events: none; z-index: 80;
        }
        .notif-msg {
            background: rgba(0,0,0,0.8); color: #fbbf24; padding: 6px 12px; border-radius: 20px;
            font-size: 14px; font-weight: bold; animation: fadeUp 2s forwards; border: 1px solid #fbbf24;
        }
        @keyframes fadeUp { 
            0% { opacity: 0; transform: translateY(20px); } 
            10% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); } 
        }

        /* Overlays - Z-Index Lower than UI */
        #danger-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, rgba(200, 0, 0, 0.4) 100%);
            pointer-events: none; z-index: 20; display: none;
            animation: pulse-red 1s infinite alternate;
        }
        @keyframes pulse-red { from { opacity: 0.5; } to { opacity: 1.0; } }
        #danger-text {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            color: #ef4444; font-size: 24px; font-weight: 900; text-align: center;
            display: none; z-index: 21; text-shadow: 0 0 10px black;
        }

        #damage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 50px rgba(255, 0, 0, 0.5);
            pointer-events: none; z-index: 22; display: none;
        }

        /* Modals - Highest Z-Index */
        #build-modal, #level-modal, #cheat-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .modal-content { width: 100%; max-width: 400px; height: 100%; display: flex; flex-direction: column; margin: 0 auto; pointer-events: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: white; }
        .tab-btn { background: transparent; border: none; color: #9ca3af; font-size: 16px; font-weight: bold; padding: 10px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #fbbf24; border-bottom-color: #fbbf24; }
        #build-list, #level-preview-list, #cheat-list { overflow-y: auto; flex: 1; gap: 10px; display: flex; flex-direction: column; }
        
        .build-card, .level-row, .cheat-card { background: #1f2937; padding: 12px; border-radius: 8px; border: 1px solid #374151; display: flex; justify-content: space-between; align-items: center; }
        .build-info h3 { color: white; font-weight: bold; font-size: 14px; }
        .build-info p { color: #9ca3af; font-size: 11px; }
        .build-cost { font-size: 11px; color: #fbbf24; margin-top: 4px; }
        .build-btn { background: #2563eb; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 12px; }
        .build-btn:disabled { background: #4b5563; }
        .build-btn.built { background: #10b981; color: white; cursor: default; }
        
        .level-row.current { border-color: #fbbf24; background: rgba(251,191,36,0.1); }
        .level-num { color: white; font-weight: bold; }
        .level-reward { color: #34d399; font-weight: bold; text-align: right; font-size: 12px; }

        .cheat-btn { width: 100%; padding: 10px; background: #4b5563; color: white; border-radius: 8px; font-weight: bold; text-align: left; margin-bottom: 5px; }
        .cheat-btn:hover { background: #6b7280; }

    </style>
</head>
<body>

    <div id="canvas-container"></div>
    <div id="danger-overlay"></div>
    <div id="damage-overlay"></div>
    <div id="danger-text">âš ï¸ ìœ„í—˜ êµ¬ì—­ âš ï¸<br><span style="font-size:14px; color:white;">ë‹¤ì´ë¹™ ë ˆë²¨ ë¶€ì¡±! ì‚°ì†Œê°€ ê¸‰ê²©íˆ ì†Œëª¨ë©ë‹ˆë‹¤.</span></div>

    <!-- Top Left Panel: Level & Safe Resources -->
    <div id="top-panel">
        <div id="left-col">
            <!-- Level -->
            <div id="level-container" onclick="openLevelModal()">
                <div id="level-badge">1</div>
                <div>
                    <div style="font-size: 11px; color: #fbbf24; font-weight: bold; margin-left: 5px;">ê³„ì • ë ˆë²¨ (í´ë¦­)</div>
                    <div id="xp-bar-container">
                        <div id="xp-fill"></div>
                        <div id="xp-text">0 / 100 XP</div>
                    </div>
                </div>
            </div>

            <!-- Safe Warehouse -->
            <div id="warehouse-panel">
                <div class="wh-header">ğŸ“¦ íšë“í•œ ìì› (ì°½ê³ )</div>
                <!-- Items will be injected via JS -->
                <div id="warehouse-list" style="display:flex; flex-direction:column; gap:4px;"></div>
            </div>
        </div>
        
        <!-- Top Right: Backpack -->
        <div id="backpack-panel">
            <div class="bp-header">
                <span>ğŸ’ ê°€ë°© (ì„ì‹œ)</span>
                <span id="backpack-count-val">0/5</span>
            </div>
            <div id="backpack-slots"></div>
        </div>
    </div>

    <!-- Left Middle: Equipment Levels -->
    <div id="equip-panel">
        <div class="equip-badge">
            <div class="equip-icon" style="border-color: #fb923c; color: #fb923c;">ğŸª</div>
            <div class="equip-info">
                <span class="equip-label">ê°ˆê³ ë¦¬</span>
                <span class="equip-val" style="color: #fb923c;">Lv.<span id="val-hook">1</span></span>
            </div>
        </div>
        <div class="equip-badge">
            <div class="equip-icon" style="border-color: #22d3ee; color: #22d3ee;">ğŸ¤¿</div>
            <div class="equip-info">
                <span class="equip-label">ë‹¤ì´ë¹™</span>
                <span class="equip-val" style="color: #22d3ee;">Lv.<span id="val-diving">1</span></span>
            </div>
        </div>
    </div>

    <!-- Bottom Left: Vitals -->
    <div id="stats-panel">
        <div class="stat-bar-box">
            <div class="stat-icon">HP</div>
            <div id="hud-hp" class="stat-fill hp-fill"></div>
        </div>
        <div class="stat-bar-box">
            <div class="stat-icon">O2</div>
            <div id="hud-oxy" class="stat-fill oxy-fill"></div>
        </div>
    </div>

    <!-- Notifications & Labels -->
    <div id="notification-area"></div>
    <div id="ui-layer"></div>

    <!-- Controls -->
    <div id="joystick-zone"><div id="joystick-knob"></div></div>
    <div id="build-menu-btn"><span>ğŸ”¨</span>ê±´ì„¤</div>
    <div id="cheat-menu-btn"><span>âš¡</span></div>

    <!-- Build Modal -->
    <div id="build-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">ğŸ”¨ ê±´ì„¤ & ì„±ì¥</h2>
                <button onclick="document.getElementById('build-modal').style.display='none'" class="text-2xl">âœ•</button>
            </div>
            <div class="flex gap-4 mb-2 border-b border-gray-700 pb-2">
                <button class="tab-btn active" onclick="switchTab('growth')">ì„±ì¥ (ì¥ë¹„)</button>
                <button class="tab-btn" onclick="switchTab('deco')">êµ¬ì¡°ë¬¼ (XP)</button>
            </div>
            <div id="build-list"></div>
        </div>
    </div>

    <!-- Level Modal -->
    <div id="level-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-green-400">ğŸ“ˆ ì„±ì¥ ë„ê°</h2>
                <button onclick="document.getElementById('level-modal').style.display='none'" class="text-2xl">âœ•</button>
            </div>
            <div id="level-preview-list"></div>
        </div>
    </div>

    <!-- Cheat Modal -->
    <div id="cheat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-purple-400">âš¡ ì¹˜íŠ¸ ëª¨ë“œ</h2>
                <button onclick="document.getElementById('cheat-modal').style.display='none'" class="text-2xl">âœ•</button>
            </div>
            <div id="cheat-list">
                <button class="cheat-btn" onclick="useCheat('all')">ğŸ’ ëª¨ë“  ìì› +50</button>
                <button class="cheat-btn" onclick="useCheat('level')">ğŸ†™ ë ˆë²¨ ì—…!</button>
                <button class="cheat-btn" onclick="useCheat('heal')">â¤ï¸ ì™„ì „ íšŒë³µ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- 0. Global Helpers (Defined early to prevent ReferenceError) ---
        window.showNotification = function(msg) {
            const container = document.getElementById('notification-area');
            if (!container) return;
            const el = document.createElement('div'); 
            el.className = 'notif-msg'; 
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // --- 1. Config ---
        const GameConfig = {
            baseHp: 100, baseCargo: 5, baseSpeed: 0.15, baseDmg: 20,
            statSequence: ['hp', 'cargo', 'speed', 'dmg'],
            rewards: {
                'hp': { val: 20, name: "ì²´ë ¥", icon: "â¤ï¸" },
                'cargo': { val: 2, name: "ê°€ë°©", icon: "ğŸ’" },
                'speed': { val: 0.02, name: "ì†ë„", icon: "ğŸŠ" },
                'dmg': { val: 10, name: "ì±„ì§‘ ì†ë„", icon: "âš”ï¸" }
            },
            harvestRange: 3.0,
            // Shark Config
            sharkSpeed: 0.05,
            sharkChaseSpeed: 0.12,
            sharkDetectRange: 12,
            sharkAttackRange: 1.5,
            sharkDamage: 15,
            tiers: {
                1: { name: 'Tier 1', xp: 2, icon: 'ğŸªµ' }, 
                2: { name: 'Tier 2', xp: 5, icon: 'âš™ï¸' }, 
                3: { name: 'Tier 3', xp: 15, icon: 'ğŸ“€' }, 
                4: { name: 'Tier 4', xp: 30, icon: 'ğŸ’' }, 
            }
        };

        const iconMap = { 'wood': 'ğŸªµ', 'plastic': 'ğŸ¥¤', 'scrap': 'âš™ï¸', 'gold': 'ğŸ“€', 'gem': 'ğŸ’' };
        const colorMap = { 'wood': '#ffffff', 'plastic': '#ffffff', 'scrap': '#9ca3af', 'gold': '#fbbf24', 'gem': '#22d3ee' };

        const gameState = {
            level: 1, xp: 0, maxXp: 100,
            hookLevel: 1, divingLevel: 1,
            wood: 0, plastic: 0, scrap: 0, gold: 0, gem: 0,
            hp: 100, maxHp: 100, oxygen: 100, maxOxygen: 100,
            isDead: false, isSwimming: false,
            backpack: [], maxBackpack: 5,
            builtStructures: [],
            gameTime: 0, lastFullBagAlert: 0
        };

        // Deep Sea Zones
        const deepSeaZones = [];
        function initDeepSeaZones() {
            for(let i=0; i<3; i++) {
                const angle = Math.random() * Math.PI * 2;
                const dist = 30 + Math.random() * 10; 
                deepSeaZones.push({
                    x: Math.cos(angle) * dist, z: Math.sin(angle) * dist,
                    r: 12, level: 2
                });
            }
            for(let i=0; i<2; i++) {
                const angle = Math.random() * Math.PI * 2;
                const dist = 50 + Math.random() * 15; 
                deepSeaZones.push({
                    x: Math.cos(angle) * dist, z: Math.sin(angle) * dist,
                    r: 15, level: 3
                });
            }
        }
        initDeepSeaZones();

        function getStatIncreaseType(level) {
            if (level <= 1) return null;
            return GameConfig.statSequence[(level - 2) % 4];
        }
        function calculateStats(currentLevel) {
            let hp = GameConfig.baseHp, cargo = GameConfig.baseCargo, speed = GameConfig.baseSpeed, dmg = GameConfig.baseDmg;
            for (let i = 2; i <= currentLevel; i++) {
                const type = getStatIncreaseType(i);
                const r = GameConfig.rewards[type];
                if (type === 'hp') hp += r.val;
                if (type === 'cargo') cargo += r.val;
                if (type === 'speed') speed += r.val;
                if (type === 'dmg') dmg += r.val;
            }
            return { hp, cargo, speed, dmg };
        }

        // --- Three.js ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 10, 80);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Ocean
        const oceanGeo = new THREE.PlaneGeometry(200, 200, 60, 60);
        oceanGeo.rotateX(-Math.PI / 2);
        const oceanMat = new THREE.MeshPhongMaterial({ color: 0x006994, shininess: 80, transparent: true, opacity: 0.9, flatShading: true });
        const ocean = new THREE.Mesh(oceanGeo, oceanMat);
        scene.add(ocean);

        // Visualizing Deep Sea Zones
        deepSeaZones.forEach(zone => {
            const geo = new THREE.CircleGeometry(zone.r, 32);
            geo.rotateX(-Math.PI / 2);
            const col = zone.level === 3 ? 0x000022 : 0x000055; 
            const mat = new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: 0.5, depthWrite: false });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(zone.x, 0.1, zone.z);
            scene.add(mesh);
        });

        // Raft
        const raftGroup = new THREE.Group();
        scene.add(raftGroup);
        const raftSize = 10;
        const logGeo = new THREE.CylinderGeometry(0.4, 0.4, raftSize, 8);
        const logMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
        for(let i=0; i<raftSize; i++) {
            const log = new THREE.Mesh(logGeo, logMat);
            log.rotation.z = Math.PI / 2;
            log.position.z = (i - raftSize/2 + 0.5) * 0.85;
            raftGroup.add(log);
        }

        // Player
        const playerGroup = new THREE.Group();
        scene.add(playerGroup);
        const playerMesh = new THREE.Group();
        playerGroup.add(playerMesh);
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.4), new THREE.MeshLambertMaterial({ color: 0x3b82f6 }));
        body.position.y = 0.4;
        playerMesh.add(body);
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshLambertMaterial({ color: 0xFFD700 }));
        head.position.y = 1.0;
        playerMesh.add(head);

        const rangeMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5, side: THREE.DoubleSide });
        const harvestRangeMesh = new THREE.Mesh(new THREE.RingGeometry(GameConfig.harvestRange-0.1, GameConfig.harvestRange, 32), rangeMat);
        harvestRangeMesh.rotation.x = -Math.PI / 2;
        harvestRangeMesh.position.y = 0.3;
        harvestRangeMesh.visible = false;
        playerGroup.add(harvestRangeMesh);

        // --- SHARKS ---
        const sharks = [];
        const sharkGeo = new THREE.Group();
        // Shark Body
        const sBody = new THREE.Mesh(new THREE.ConeGeometry(0.5, 2, 8), new THREE.MeshLambertMaterial({ color: 0x444444 }));
        sBody.rotation.x = Math.PI / 2;
        sharkGeo.add(sBody);
        // Shark Fin
        const sFin = new THREE.Mesh(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0.3,0), new THREE.Vector3(0,0.8,0.5), new THREE.Vector3(0,0.3,1)]), new THREE.MeshLambertMaterial({color: 0x444444}));
        sharkGeo.add(sFin);
        // Detection Range Visual
        const detectGeo = new THREE.RingGeometry(GameConfig.sharkDetectRange - 0.2, GameConfig.sharkDetectRange, 32);
        const detectMat = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.2, side: THREE.DoubleSide, depthWrite: false });
        const detectMesh = new THREE.Mesh(detectGeo, detectMat);
        detectMesh.rotation.x = -Math.PI / 2;
        detectMesh.position.y = -0.5;
        sharkGeo.add(detectMesh);

        function spawnSharks() {
            for(let i=0; i<3; i++) {
                const shark = sharkGeo.clone();
                const zone = deepSeaZones[i % deepSeaZones.length];
                shark.position.set(zone.x, 0, zone.z);
                
                const sData = {
                    home: new THREE.Vector3(zone.x, 0, zone.z),
                    patrolRadius: 20 + Math.random() * 10,
                    angle: Math.random() * Math.PI * 2,
                    state: 'PATROL', 
                    speed: GameConfig.sharkSpeed * (0.9 + Math.random()*0.2)
                };
                shark.userData = sData;
                scene.add(shark);
                sharks.push(shark);
            }
        }
        spawnSharks();

        // Resources
        const resources = [];
        const resGeos = {
            wood: new THREE.CylinderGeometry(0.1, 0.1, 2, 6),
            plastic: new THREE.BoxGeometry(0.5, 0.5, 0.5),
            scrap: new THREE.DodecahedronGeometry(0.4),
            gold: new THREE.SphereGeometry(0.4, 8, 8),
            gem: new THREE.OctahedronGeometry(0.4)
        };
        const resMats = {
            wood: new THREE.MeshLambertMaterial({ color: 0x8B4513 }),
            plastic: new THREE.MeshPhongMaterial({ color: 0xEEEEEE }),
            scrap: new THREE.MeshStandardMaterial({ color: 0x708090, roughness: 0.4, metalness: 0.8 }),
            gold: new THREE.MeshPhongMaterial({ color: 0xFFD700, shininess: 100 }),
            gem: new THREE.MeshPhongMaterial({ color: 0x22d3ee, emissive: 0x004444, shininess: 100 })
        };

        function spawnResource() {
            if(resources.length > 200) return; 

            let targetZone = null;
            if (Math.random() < 0.5) {
                targetZone = deepSeaZones[Math.floor(Math.random() * deepSeaZones.length)];
            }

            let x, z;
            if (targetZone) {
                const r = Math.random() * targetZone.r;
                const theta = Math.random() * Math.PI * 2;
                x = targetZone.x + Math.cos(theta) * r;
                z = targetZone.z + Math.sin(theta) * r;
            } else {
                const angle = Math.random() * Math.PI * 2;
                const dist = 10 + Math.random() * 60; 
                x = Math.cos(angle) * dist;
                z = Math.sin(angle) * dist;
                
                for(const zone of deepSeaZones) {
                    if (Math.hypot(x-zone.x, z-zone.z) < zone.r) {
                        targetZone = zone;
                        break;
                    }
                }
            }

            let type = 'wood';
            let reqHook = 1;
            let hp = 10;
            let tier = 1;
            const rand = Math.random();

            if (targetZone) {
                if (targetZone.level === 3) {
                    if (rand < 0.4) { type='gem'; tier=4; reqHook=4; hp=50; }
                    else if (rand < 0.8) { type='gold'; tier=3; reqHook=3; hp=35; }
                    else { type='scrap'; tier=2; reqHook=2; hp=20; }
                } else {
                    if (rand < 0.3) { type='gold'; tier=3; reqHook=3; hp=35; }
                    else if (rand < 0.8) { type='scrap'; tier=2; reqHook=2; hp=20; }
                    else { type='plastic'; tier=1; reqHook=1; hp=10; }
                }
            } else {
                if (rand < 0.5) type='wood';
                else if (rand < 0.9) type='plastic';
                else { type='scrap'; tier=2; reqHook=2; hp=20; }
            }

            const mesh = new THREE.Mesh(resGeos[type], resMats[type]);
            mesh.position.set(x, 0, z);
            mesh.userData = { type, hp, maxHp: hp, reqHook, tier, floatOffset: Math.random() * 100 };
            scene.add(mesh);
            resources.push(mesh);
        }

        // --- Buildings ---
        const buildingsGroup = new THREE.Group();
        raftGroup.add(buildingsGroup);

        const BuildingsDB = {
            'hook_station': {
                id: 'hook_station', name: 'ê°ˆê³ ë¦¬ ì œë ¨ì†Œ', type: 'growth',
                cost: { wood: 10, plastic: 5 },
                desc: 'ê°ˆê³ ë¦¬ ë ˆë²¨ì„ ì˜¬ë¦½ë‹ˆë‹¤.',
                xp: 50, modelColor: 0xff0000,
                onBuild: () => {
                    gameState.hookLevel++;
                    window.showNotification(`âš”ï¸ ê°ˆê³ ë¦¬ Lv.${gameState.hookLevel}`);
                    BuildingsDB['hook_station'].cost.wood += 20;
                    BuildingsDB['hook_station'].cost.plastic += 10;
                    if(gameState.hookLevel>=2) BuildingsDB['hook_station'].cost.scrap = 10 * (gameState.hookLevel-1);
                    if(gameState.hookLevel>=3) BuildingsDB['hook_station'].cost.gold = 5 * (gameState.hookLevel-2);
                }
            },
            'diving_station': {
                id: 'diving_station', name: 'ë‹¤ì´ë¹™ ì„¼í„°', type: 'growth',
                cost: { wood: 15, plastic: 10 },
                desc: 'ë” ê¹Šì€ ì‹¬í•´ êµ¬ì—­ íƒí—˜.',
                xp: 50, modelColor: 0x0000ff,
                onBuild: () => {
                    gameState.divingLevel++;
                    window.showNotification(`ğŸ¤¿ ë‹¤ì´ë¹™ Lv.${gameState.divingLevel}`);
                    BuildingsDB['diving_station'].cost.wood += 25;
                    BuildingsDB['diving_station'].cost.plastic += 15;
                    if(gameState.divingLevel>=2) BuildingsDB['diving_station'].cost.scrap = 10 * (gameState.divingLevel-1);
                    if(gameState.divingLevel>=3) BuildingsDB['diving_station'].cost.gold = 5 * (gameState.divingLevel-2);
                }
            },
            'grill': { id: 'grill', name: 'ìƒì¡´ ê·¸ë¦´', type: 'deco', cost: { wood: 20, scrap: 5 }, desc: 'ë§›ìˆëŠ” ìš”ë¦¬ë¥¼ ìœ„í•œ ì‹œì‘.', xp: 150, oneTime: true, model: 'box', modelScale: [0.8, 0.5, 0.8], modelColor: 0x333333 },
            'purifier': { id: 'purifier', name: 'ì •ìˆ˜ê¸°', type: 'deco', cost: { plastic: 25, scrap: 5 }, desc: 'ê¹¨ë—í•œ ë¬¼ì€ ìƒì¡´ì˜ í•„ìˆ˜í’ˆ.', xp: 150, oneTime: true, model: 'cylinder', modelScale: [0.5, 1.0, 0.5], modelColor: 0xaaccff },
            'lantern': { id: 'lantern', name: 'ëœí„´', type: 'deco', cost: { wood: 10, scrap: 2 }, desc: 'ì–´ë‘ìš´ ë°¤ì„ ë°í˜€ì¤ë‹ˆë‹¤.', xp: 100, oneTime: true, model: 'cylinder', modelScale: [0.2, 0.5, 0.2], modelColor: 0xffff00 },
            'chair': { id: 'chair', name: 'ë‚˜ë¬´ ì˜ì', type: 'deco', cost: { wood: 15 }, desc: 'ì ì‹œ ì•‰ì•„ ì‰¬ì–´ê°€ì„¸ìš”.', xp: 80, oneTime: true, model: 'box', modelScale: [0.5, 0.5, 0.5], modelColor: 0x8B4513 },
            'radio': { id: 'radio', name: 'ë¼ë””ì˜¤', type: 'deco', cost: { scrap: 20, gold: 1 }, desc: 'ëˆ„êµ°ê°€ì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ë©°...', xp: 300, oneTime: true, model: 'box', modelScale: [0.6, 0.4, 0.3], modelColor: 0x222222 },
            'plant': { id: 'plant', name: 'ì‘ì€ í™”ë¶„', type: 'deco', cost: { plastic: 5, wood: 5 }, desc: 'ì‚­ë§‰í•œ ë°”ë‹¤ ìœ„ ì‘ì€ í¬ë§.', xp: 100, oneTime: true, model: 'cylinder', modelScale: [0.4, 0.6, 0.4], modelColor: 0x228B22 },
            'cat_tower': { id: 'cat_tower', name: 'ìº£íƒ€ì›Œ', type: 'deco', cost: { wood: 40, scrap: 10 }, desc: 'ê³ ì–‘ì´ëŠ” ì—†ì§€ë§Œ...', xp: 250, oneTime: true, model: 'box', modelScale: [0.6, 1.5, 0.6], modelColor: 0xffccaa },
            'bed': { id: 'bed', name: 'í¸ì•ˆí•œ ì¹¨ëŒ€', type: 'deco', cost: { wood: 50, plastic: 30 }, desc: 'ì´ì œ ë—ëª©ì€ ì§‘ì…ë‹ˆë‹¤.', xp: 400, oneTime: true, model: 'box', modelScale: [1, 0.3, 1.8], modelColor: 0xffffff }
        };

        function buildItem(id) {
            const item = BuildingsDB[id];
            if (item.oneTime && gameState.builtStructures.includes(id)) return;

            // Cost Check
            if (gameState.wood < (item.cost.wood||0) || gameState.plastic < (item.cost.plastic||0) || 
                gameState.scrap < (item.cost.scrap||0) || gameState.gold < (item.cost.gold||0) || gameState.gem < (item.cost.gem||0)) {
                window.showNotification("ìì› ë¶€ì¡±!"); return;
            }
            gameState.wood -= (item.cost.wood||0);
            gameState.plastic -= (item.cost.plastic||0);
            gameState.scrap -= (item.cost.scrap||0);
            gameState.gold -= (item.cost.gold||0);
            gameState.gem -= (item.cost.gem||0);

            gainXp(item.xp);
            if (item.onBuild) item.onBuild();
            if (item.oneTime) gameState.builtStructures.push(id);
            
            let mesh;
            if (item.model === 'cylinder') mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 1), new THREE.MeshLambertMaterial({color: item.modelColor || 0xffffff}));
            else mesh = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshLambertMaterial({color: item.modelColor || 0xffffff}));
            if(item.modelScale) mesh.scale.set(...item.modelScale);
            mesh.position.set((Math.random()-0.5)*8, 0.5, (Math.random()-0.5)*8);
            buildingsGroup.add(mesh);

            updateUI(); 
            const activeTab = document.querySelector('.tab-btn.active');
            if(activeTab) renderBuildMenu(activeTab.innerText.includes('ì„±ì¥') ? 'growth' : 'deco');
            window.showNotification(`${item.name} ê±´ì„¤! (+${item.xp} XP)`);
        }
        window.buildItem = buildItem;

        function gainXp(amount) {
            gameState.xp += amount;
            while(gameState.xp >= gameState.maxXp) {
                gameState.xp -= gameState.maxXp;
                gameState.level++;
                gameState.maxXp = Math.floor(gameState.maxXp * 1.5);
                const stats = calculateStats(gameState.level);
                gameState.maxHp = stats.hp; gameState.hp = stats.hp;
                gameState.maxBackpack = stats.cargo;
                const type = getStatIncreaseType(gameState.level);
                const r = GameConfig.rewards[type];
                window.showNotification(`LEVEL UP! Lv.${gameState.level} (${r.name} â†‘)`);
            }
            updateUI();
        }

        // --- Hook Lines ---
        const hookLines = []; 
        const lineMat = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 });

        function updateHookLines(targets) {
            for (let i = hookLines.length - 1; i >= 0; i--) {
                const hook = hookLines[i];
                if (!targets.includes(hook.target) || hook.target.userData.hp <= 0) {
                    scene.remove(hook.mesh);
                    hookLines.splice(i, 1);
                }
            }
            targets.forEach(target => {
                const existing = hookLines.find(h => h.target === target);
                if (!existing) {
                    const geo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3()]);
                    const line = new THREE.Line(geo, lineMat);
                    scene.add(line);
                    hookLines.push({ mesh: line, target: target });
                }
            });
            const startPos = playerGroup.position.clone().add(new THREE.Vector3(0, 0.5, 0)); 
            hookLines.forEach(hook => {
                const positions = hook.mesh.geometry.attributes.position.array;
                positions[0] = startPos.x; positions[1] = startPos.y; positions[2] = startPos.z;
                positions[3] = hook.target.position.x; positions[4] = hook.target.position.y; positions[5] = hook.target.position.z;
                hook.mesh.geometry.attributes.position.needsUpdate = true;
            });
        }

        // --- UI ---
        const uiLayer = document.getElementById('ui-layer');
        const dangerOverlay = document.getElementById('danger-overlay');
        const dangerText = document.getElementById('danger-text');
        const dmgOverlay = document.getElementById('damage-overlay');

        function updateUI() {
            const xpPct = (gameState.xp / gameState.maxXp) * 100;
            document.getElementById('xp-fill').style.width = `${xpPct}%`;
            document.getElementById('xp-text').innerText = `${gameState.xp}/${gameState.maxXp} XP`;
            document.getElementById('level-badge').innerText = gameState.level;

            const stats = calculateStats(gameState.level);
            document.getElementById('val-hook').innerText = gameState.hookLevel;
            document.getElementById('val-diving').innerText = gameState.divingLevel;
            
            // Warehouse (Filter 0 items)
            const whList = document.getElementById('warehouse-list');
            whList.innerHTML = '';
            const resources = [
                {k:'wood', n:'ë‚˜ë¬´', c:colorMap.wood},
                {k:'plastic', n:'í”Œë¼ìŠ¤í‹±', c:colorMap.plastic},
                {k:'scrap', n:'ìŠ¤í¬ë©', c:colorMap.scrap},
                {k:'gold', n:'ê¸ˆí™”', c:colorMap.gold},
                {k:'gem', n:'ë‹¤ì´ì•„', c:colorMap.gem}
            ];
            resources.forEach(r => {
                if(gameState[r.k] > 0) {
                    const div = document.createElement('div');
                    div.className = 'wh-item';
                    div.style.color = r.c;
                    div.innerHTML = `${iconMap[r.k]} ${r.n} <span>${gameState[r.k]}</span>`;
                    whList.appendChild(div);
                }
            });

            document.getElementById('backpack-count-val').innerText = `${gameState.backpack.length}/${gameState.maxBackpack}`;
            const slotContainer = document.getElementById('backpack-slots');
            slotContainer.innerHTML = '';
            gameState.backpack.forEach(item => {
                const s = document.createElement('div');
                s.className = 'backpack-slot';
                s.innerText = iconMap[item.type];
                slotContainer.appendChild(s);
            });

            document.getElementById('hud-hp').style.width = `${(gameState.hp/gameState.maxHp)*100}%`;
            document.getElementById('hud-oxy').style.width = `${(gameState.oxygen/gameState.maxOxygen)*100}%`;
        }

        // --- Loop ---
        const clock = new THREE.Clock();
        const joystick = { x: 0, y: 0, active: false };
        const joyZone = document.getElementById('joystick-zone');
        const joyKnob = document.getElementById('joystick-knob');
        let joyStart = { x: 0, y: 0 };
        const handleStart = (cx, cy) => { joystick.active=true; joyStart.x=cx; joyStart.y=cy; };
        const handleMove = (cx, cy) => { if(!joystick.active)return; const dx=cx-joyStart.x, dy=cy-joyStart.y, dist=Math.min(50,Math.hypot(dx,dy)), ang=Math.atan2(dy,dx); const kx=Math.cos(ang)*dist, ky=Math.sin(ang)*dist; joyKnob.style.transform=`translate(${kx}px,${ky}px)`; joystick.x=kx/50; joystick.y=ky/50; };
        const handleEnd = () => { joystick.active=false; joystick.x=0; joystick.y=0; joyKnob.style.transform='translate(0,0)'; };
        joyZone.addEventListener('touchstart', e=>{e.preventDefault(); handleStart(e.touches[0].clientX,e.touches[0].clientY)});
        joyZone.addEventListener('touchmove', e=>{if(joystick.active){e.preventDefault(); handleMove(e.touches[0].clientX,e.touches[0].clientY)}});
        joyZone.addEventListener('touchend', handleEnd);
        window.addEventListener('mousedown', e=>{if(e.target===joyZone)handleStart(e.clientX,e.clientY)});
        window.addEventListener('mousemove', e=>handleMove(e.clientX,e.clientY));
        window.addEventListener('mouseup', handleEnd);

        const keys = { w: false, s: false, a: false, d: false };
        window.addEventListener('keydown', e=>{
            const k = e.code;
            if(k==='KeyW'||k==='ArrowUp') keys.w=true;
            if(k==='KeyS'||k==='ArrowDown') keys.s=true;
            if(k==='KeyA'||k==='ArrowLeft') keys.a=true;
            if(k==='KeyD'||k==='ArrowRight') keys.d=true;
        });
        window.addEventListener('keyup', e=>{
            const k = e.code;
            if(k==='KeyW'||k==='ArrowUp') keys.w=false;
            if(k==='KeyS'||k==='ArrowDown') keys.s=false;
            if(k==='KeyA'||k==='ArrowLeft') keys.a=false;
            if(k==='KeyD'||k==='ArrowRight') keys.d=false;
        });

        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), 0.1);
            if(gameState.isDead) return;

            const stats = calculateStats(gameState.level);
            let mx = joystick.x, my = joystick.y;
            if(!joystick.active) {
                if(keys.w) my = -1; if(keys.s) my = 1; if(keys.a) mx = -1; if(keys.d) mx = 1;
                if(mx||my) { const l=Math.hypot(mx,my); mx/=l; my/=l; }
            }
            if(Math.abs(mx)>0.1 || Math.abs(my)>0.1) {
                playerGroup.position.x += mx * stats.speed;
                playerGroup.position.z += my * stats.speed;
                playerMesh.rotation.y = Math.atan2(mx, my);
            }

            const distRaft = Math.hypot(playerGroup.position.x, playerGroup.position.z);
            if (distRaft < 6) { 
                gameState.isSwimming = false;
                harvestRangeMesh.visible = false;
                playerGroup.position.y = 0.5;
                playerMesh.rotation.x = 0;
                
                if(gameState.backpack.length > 0) {
                    gameState.backpack.forEach(it => { gameState[it.type] = (gameState[it.type]||0)+1; });
                    window.showNotification(`ğŸ“¦ ìì› ë³´ê´€ ì™„ë£Œ (+${gameState.backpack.length})`);
                    gameState.backpack = [];
                }
                gameState.oxygen = Math.min(gameState.oxygen + 20*dt, gameState.maxOxygen);
                dangerOverlay.style.display = 'none';
                dangerText.style.display = 'none';
                updateHookLines([]);
                
                // Shark Reset if player safe
                sharks.forEach(s => s.userData.state = 'PATROL');

            } else {
                gameState.isSwimming = true;
                harvestRangeMesh.visible = true;
                playerGroup.position.y = -0.2;
                playerMesh.rotation.x = Math.PI/2;

                let currentZoneLevel = 0;
                for(const zone of deepSeaZones) {
                    const d = Math.hypot(playerGroup.position.x - zone.x, playerGroup.position.z - zone.z);
                    if (d < zone.r) {
                        currentZoneLevel = zone.level;
                        break;
                    }
                }

                if (currentZoneLevel > gameState.divingLevel) {
                    dangerOverlay.style.display = 'block';
                    dangerText.style.display = 'block';
                    gameState.oxygen -= 15 * dt; 
                    if(gameState.oxygen<=0) gameState.hp -= 30 * dt;
                } else {
                    dangerOverlay.style.display = 'none';
                    dangerText.style.display = 'none';
                    gameState.oxygen -= 2 * dt; 
                    if(gameState.oxygen<=0) gameState.hp -= 5 * dt;
                }
            }

            if(Math.random()<0.2) spawnResource(); 
            uiLayer.innerHTML = ''; 

            // Zone Labels
            deepSeaZones.forEach(zone => {
                const distToZone = Math.hypot(playerGroup.position.x - zone.x, playerGroup.position.z - zone.z);
                if(distToZone < 40) {
                    const v = new THREE.Vector3(zone.x, 0, zone.z).project(camera);
                    const x = (v.x * .5 + .5) * window.innerWidth;
                    const y = (-(v.y * .5) + .5) * window.innerHeight;
                    if(x>0 && x<window.innerWidth && y>0 && y<window.innerHeight) {
                        const el = document.createElement('div');
                        el.className = 'zone-label';
                        el.style.left = x+'px'; el.style.top = y+'px';
                        el.innerText = `ì‹¬í•´ êµ¬ì—­ Lv.${zone.level}`;
                        uiLayer.appendChild(el);
                    }
                }
            });

            // Sharks
            const fpsScale = dt * 60; 
            sharks.forEach(shark => {
                const data = shark.userData;
                const distToPlayer = shark.position.distanceTo(playerGroup.position);
                
                if (data.state === 'PATROL') {
                    if (gameState.isSwimming && distToPlayer < GameConfig.sharkDetectRange) {
                        data.state = 'CHASE';
                    } else {
                        data.angle += 0.005 * fpsScale;
                        const targetX = data.home.x + Math.cos(data.angle) * data.patrolRadius;
                        const targetZ = data.home.z + Math.sin(data.angle) * data.patrolRadius;
                        shark.lookAt(targetX, 0, targetZ);
                        shark.translateZ(data.speed * fpsScale);
                    }
                } else if (data.state === 'CHASE') {
                    if (!gameState.isSwimming || distToPlayer > GameConfig.sharkDetectRange * 1.5) {
                        data.state = 'PATROL';
                    } else {
                        shark.lookAt(playerGroup.position.x, 0, playerGroup.position.z);
                        shark.translateZ(GameConfig.sharkChaseSpeed * fpsScale);

                        const hitDist = GameConfig.sharkAttackRange + 0.3;
                        if (distToPlayer < hitDist) {
                            gameState.hp -= GameConfig.sharkDamage * dt;
                            dmgOverlay.style.display = 'block';
                            setTimeout(() => dmgOverlay.style.display = 'none', 100);
                            
                            const pushDir = playerGroup.position.clone().sub(shark.position).normalize();
                            playerGroup.position.add(pushDir.multiplyScalar(0.5 * fpsScale));
                        }
                    }
                }
            });

            const hookDmg = stats.dmg * dt;
            const hookedTargets = [];

            resources.forEach((res, idx) => {
                res.position.y = Math.sin(gameState.gameTime*2 + res.userData.floatOffset)*0.2;
                res.rotation.y += dt;
                const dist = playerGroup.position.distanceTo(res.position);
                
                const vec = res.position.clone(); vec.y+=1.5; vec.project(camera);
                const sx = (vec.x*.5+.5)*window.innerWidth, sy = (-(vec.y*.5)+.5)*window.innerHeight;
                const onScreen = sx>0 && sx<window.innerWidth && sy>0 && sy<window.innerHeight;

                if(gameState.isSwimming && dist < 15 && res.userData.reqHook > gameState.hookLevel && onScreen) {
                    const l = document.createElement('div'); l.className='req-label';
                    l.style.left=sx+'px'; l.style.top = sy+'px';
                    l.innerText=`ê°ˆê³ ë¦¬ Lv.${res.userData.reqHook} í•„ìš”`;
                    uiLayer.appendChild(l);
                }

                if(gameState.isSwimming && dist < GameConfig.harvestRange) {
                    if(gameState.hookLevel >= res.userData.reqHook) {
                        if(gameState.backpack.length < gameState.maxBackpack) {
                            hookedTargets.push(res);
                            res.userData.hp -= hookDmg;
                            res.scale.setScalar(0.8 + (res.userData.hp/res.userData.maxHp)*0.2);
                            
                            if(onScreen && res.userData.hp < res.userData.maxHp) {
                                const prog = 1 - res.userData.hp/res.userData.maxHp;
                                const g = document.createElement('div'); g.className='gauge-container';
                                g.style.left=sx+'px'; g.style.top=sy+'px';
                                g.innerHTML = `<svg width="40" height="40"><circle cx="20" cy="20" r="14" stroke="rgba(0,0,0,0.5)" stroke-width="4" fill="none"/><circle cx="20" cy="20" r="14" stroke="white" stroke-width="4" fill="none" stroke-dasharray="88" stroke-dashoffset="${(1-prog)*88}" transform="rotate(-90 20 20)"/></svg>`;
                                uiLayer.appendChild(g);
                            }

                            if(res.userData.hp <= 0) {
                                gameState.backpack.push({type:res.userData.type});
                                scene.remove(res);
                                resources.splice(idx, 1);
                                window.showNotification(`+${iconMap[res.userData.type]}`);
                            }
                        } else {
                            if(Date.now()-gameState.lastFullBagAlert > 2000) {
                                window.showNotification("ê°€ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤!");
                                gameState.lastFullBagAlert = Date.now();
                            }
                        }
                    }
                }
            });

            updateHookLines(hookedTargets);

            const targetCamPos = playerGroup.position.clone();
            targetCamPos.add(new THREE.Vector3(0, 35, 25)); 
            const camLerp = 1 - Math.pow(1 - 0.1, fpsScale);
            camera.position.lerp(targetCamPos, camLerp);
            camera.lookAt(playerGroup.position);

            updateUI();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

        // --- Modals & Cheats Logic ---
        window.openLevelModal = () => {
            const list = document.getElementById('level-preview-list');
            list.innerHTML = '';
            for(let i=0; i<6; i++) {
                const lv = gameState.level + i;
                const type = getStatIncreaseType(lv);
                const r = GameConfig.rewards[type];
                const row = document.createElement('div');
                row.className = `level-row ${i===0?'current':''}`;
                row.innerHTML = `<div class="level-info"><div class="level-num">Lv.${lv}</div></div><div class="level-reward">${i===0?'-':`${r.icon} ${r.name} +${r.val}`}</div>`;
                list.appendChild(row);
            }
            document.getElementById('level-modal').style.display='flex';
        };
        
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => {
                if(b.getAttribute('onclick').includes(tab)) b.classList.add('active');
            });
            renderBuildMenu(tab);
        };

        function renderBuildMenu(filter = 'growth') {
            const list = document.getElementById('build-list'); list.innerHTML='';
            Object.values(BuildingsDB).forEach(item => {
                if(item.type!==filter) return;
                const isBuilt = item.oneTime && gameState.builtStructures.includes(item.id);
                
                const d = document.createElement('div'); d.className='build-card';
                if(isBuilt) {
                    d.innerHTML = `<div class="build-info"><h3>${item.name}</h3><p>ê±´ì„¤ ì™„ë£Œ</p></div><button class="build-btn built" disabled>ì™„ë£Œ</button>`;
                } else {
                    let costStr = '';
                    if(item.cost.wood) costStr += `ğŸªµ${item.cost.wood} `;
                    if(item.cost.plastic) costStr += `ğŸ¥¤${item.cost.plastic} `;
                    if(item.cost.scrap) costStr += `âš™ï¸${item.cost.scrap} `;
                    if(item.cost.gold) costStr += `ğŸ“€${item.cost.gold} `;
                    if(item.cost.gem) costStr += `ğŸ’${item.cost.gem} `;
                    
                    d.innerHTML = `<div class="build-info"><h3>${item.name}</h3><p>${item.desc}</p><div class="build-cost">${costStr}</div></div><button class="build-btn" onclick="buildItem('${item.id}')">${item.type==='growth'?'ê°•í™”':'ê±´ì„¤'}</button>`;
                }
                list.appendChild(d);
            });
        }
        window.useCheat = (type) => {
            if(type==='all') { 
                gameState.wood+=50; gameState.plastic+=50; gameState.scrap+=50; gameState.gold+=50; gameState.gem+=50; 
                window.showNotification("ëª¨ë“  ìì› +50"); 
            }
            if(type==='level') { gainXp(gameState.maxXp); window.showNotification("ë ˆë²¨ ì—…!"); }
            if(type==='heal') { gameState.hp = gameState.maxHp; gameState.oxygen = gameState.maxOxygen; window.showNotification("ì™„ì „ íšŒë³µ!"); }
            updateUI();
        };
        
        document.getElementById('build-menu-btn').addEventListener('click', ()=>{
            renderBuildMenu('growth');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.tab-btn[onclick*="growth"]').classList.add('active');
            document.getElementById('build-modal').style.display='flex';
        });
        document.getElementById('cheat-menu-btn').addEventListener('click', ()=>{document.getElementById('cheat-modal').style.display='flex';});
    </script>
</body>
</html>
